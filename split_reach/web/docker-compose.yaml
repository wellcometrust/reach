version: '3.4'

services:
    postgres:
        image: postgres:11.2-alpine
        ports:
          - 127.0.0.1:5432:5432
        environment:
          POSTGRES_PASSWORD: development
        deploy:
          resources:
            limits:
              memory: "64M"

    web:
      build:
          context: ./
          dockerfile: Dockerfile
      image: uk.ac.wellcome/reach/web:latest
      ports:
        - 127.0.0.1:8081:8081
      environment:
        AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
        AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
        SENTRY_DSN: "${SENTRY_DSN}"
        STATIC_ROOT: /opt/reach/build/web/static
        DOCS_STATIC_ROOT: /opt/reach/web/docs/build/html/_static
        ELASTICSEARCH_HOST: "http://elasticsearch:9200"
        ELASTICSEARCH_POLICYDOCS_INDEX: "policy-test-docs"
        ELASTICSEARCH_CITATIONS_INDEX: "policy-test-citations"
        # DATABASE_URL: "postgres://postgres:postgres@articles-db:5432/wsf_scraping"

      command:
        - gunicorn
        - --bind=0.0.0.0:8081
        - --reload
        - web.wsgi:application
      volumes:
        - ./app:/opt/reach/web/
        - ./build/web:/opt/reach/build/web
      depends_on: ['elasticsearch']
      deploy:
        resources:
          limits:
            memory: "64M"

    # Build static assets whenever they change, and save them into
    # the STATIC_ROOT used by the web service above.
    gulp-watch:
      image: reach-web-build:latest
      command:
        - gulp
        - watch
      volumes:
        - ./build/web/static:/opt/reach/build/web/static
        - ./gulpfile.js:/opt/reach/build/web/gulpfile.js
        - ./app/src:/opt/reach/build/web/src
      # Signal handling in gulp? Not so much...
      stop_signal: SIGKILL
      deploy:
        resources:
          limits:
            memory: "96M"



    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.2.1
        environment:
          - discovery.type=single-node
          - "ES_JAVA_OPTS=-Xms512m -Xmx2g"
        ports:
          - 127.0.0.1:9200:9200
        volumes:
          - esdata:/usr/share/elasticsearch/data
        deploy:
          resources:
            limits:
              memory: "2560M"

volumes:
  esdata:
    driver: local
